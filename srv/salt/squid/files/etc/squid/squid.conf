acl localnet src 172.17.0.0/24  # RFC1918 possible internal network

acl SSL_ports port 443
acl SSL_ports port 8443
acl Safe_ports port 80          # http
acl Safe_ports port 81          # http for testing
acl Safe_ports port 443         # https
acl CONNECT method CONNECT
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager
http_access deny to_localhost
http_access allow localnet
http_access allow localhost

http_port 81 accel vhost defaultsite=site1.com
acl localip src 172.17.0.0/24
acl all src all
# include all config files:
#   include /etc/squid/conf.d/*.conf


coredump_dir /var/spool/squid
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

cache_peer 172.17.0.2 parent 8080 0 proxy-only no-query originserver no-digest login=PASS name=site1
cache_peer 172.17.0.2 parent 8081 0 proxy-only no-query originserver no-digest login=PASS name=site2
cache_peer devicereg.site1.com parent 80 0 proxy-only no-query originserver no-digest login=PASS name=site1_local
cache_peer devicelogs.site1.com parent 80 0 proxy-only no-query originserver no-digest login=PASS name=site2_local

# local site1.com
acl site1_acl dstdomain site1.com
http_access allow site1_acl all
cache_peer_access site1 allow site1_acl

# local site2.com
acl site2_acl dstdomain site2.com
http_access allow site2_acl all
cache_peer_access site2 allow site2_acl

# remote devicereg
acl site1_local_acl dstdomain devicereg.site1.com
http_access allow site1_local_acl all
cache_peer_access site1_local allow site1_local_acl

# remote devicelogs
acl site2_local_acl dstdomain devicelogs.site1.com
http_access allow site2_local_acl all
cache_peer_access site2_local allow site2_local_acl


# Additional ACL definitions
acl all src all
acl manager proto cache_object
acl localhost src 127.0.0.1/32
acl to_localhost dst 127.0.0.0/8 0.0.0.0/32
acl purge method PURGE
acl CONNECT method CONNECT

# Restrictions
http_access allow manager localhost
http_access deny manager
http_access allow purge localhost
http_access deny purge
http_access deny all

# Disable caching
cache deny all

# memory cache size
#cache_mem 256 MB

# define hostname
#visible_hostname sitename.com

via off
header_replace X-Forwarded-For deny !localnet
reply_header_access X-Squid-Error deny !localnet
reply_header_access X-Cache-Lookup deny !localnet
reply_header_access X-Cache deny !localnet
